angular.module("tourApp",["ui.toggle","ngTagsInput"]).controller("eventInfoCtrl",["$scope","$http","$window",function(n,t,i){n.mapStudent=function(i){i.preventDefault();var r=n.eventId,u=n.studentId;r&&u&&t.post("/api/event/map/"+r+"/"+u).then(function(){n.fetchInfo()})};n.unMapStudent=function(i,r){i.preventDefault();var u=n.eventId;u&&r&&t.post("/api/event/unmap/"+u+"/"+r).then(function(){n.fetchInfo()})};n.sendAdHocEmail=function(r){r.preventDefault();var e=n.eventId,u=n.emailSubject,f=angular.element(".summernote").eq(0).summernote("code");e&&u&&f&&i.confirm("Are you sure to send an email to RSVPed students?")&&t.post("/api/event/email",{emails:n.event.students.map(function(n){return n.student.email}),body:f,subject:u}).then(function(){i.alert("Successfully sent email!")})};n.fetchInfo=function(){t.get("/api/event/info/"+n.eventId).then(function(t){var i=t.data;n.event=i.event;n.availableStudents=i.availableStudents})};angular.element(".summernote").summernote()}]).controller("userListCtrl",["$scope","$http",function(){}]).controller("emailUtilityCtrl",["$timeout",function(n){n(function(){angular.element(".autoclose").fadeOut()},2e3);angular.element(".summernote").summernote()}]).controller("emailCheckInCtrl",["$scope","$http",function(n,t){n.changeAttendance=function(n,i,r){return t.post("/utility/emailCheckInAction/"+n+"/"+i+"?present="+r).then(function(){console.log("Updated the attendance")})}}]).controller("hostEditCtrl",["$scope",function(){}]).controller("hostRegistrationCtrl",["$scope",function(){}]).controller("driverEditCtrl",["$scope",function(){}]).controller("driverRegistrationCtrl",["$scope",function(){}]).controller("studentRegistrationCtrl",["$scope",function(){}]).controller("userRegistrationCtrl",["$scope",function(n){n.validateInvitationCode=function(t){n.invitation_code!==n.invitation_code_value?(n.error=!0,t.preventDefault()):n.error=!1}}]).controller("studentListCtrl",["$scope","$http",function(n,t){n.showDetail=!1;n.toggleShowDetail=function(){};n.getAllStudentsPDF=function(){t.get("/api/student").then(function(n){var e=n.data,i=new jsPDF({orientation:"l",lineHeight:1.5}),o,t,f,s,r,u;for(i.setFont("courier"),i.setFontSize(10),o=function(n,t){return n.reduce(function(n,i){return n[i]=t[i],n},{})},r=25,t=0,f=e.length;t<f;t+=r)s=e.slice(t,t+r),u=stringTable.create(s.map(function(n){return n.fullname=n.fullname&&n.fullname.substring(0,30)||"",o(["fullname","country","university","kosherFood","needCarSeat","isFamily","isPresent"],n)})),u=u.replace(/’/g,"'"),i.text(20,20,u),t+r<f&&i.addPage();i.save("student-list.pdf")})}}]).controller("driverListCtrl",["$scope","$http",function(n,t){n.getAllDriversPDF=function(){t.get("/api/driver").then(function(n){var f=n.data,r=new jsPDF({orientation:"l",lineHeight:1.5}),o,t,e,s,u,i;for(r.setFont("courier"),r.setFontSize(10),o=function(n,t){return n.reduce(function(n,i){return n[i]=t[i],n},{})},u=25,t=0,e=f.length;t<e;t+=u)s=f.slice(t,t+u),i=stringTable.create(s.map(function(n){return n.navigator=n.navigator||n.navigator==="null"?n.navigator.length>10?n.navigator.substring(0,10)+" ...":n.navigator:"-",o(["displayId","fullname","capacity","navigator","role","haveChildSeat"],n)})),i=i.replace(/’/g,"'"),t===0&&(i="Driver List ( count of drivers: "+f.length+" )\n\n"+i),r.text(20,20,i),t+u<e&&r.addPage();r.save("driver-list.pdf")})}}]).controller("hostListCtrl",["$scope","$http",function(n,t){n.getAllHostPDF=function(){t.get("/api/host").then(function(n){var f=n.data,i=new jsPDF({orientation:"l",lineHeight:1.5}),o,t,e,s,r,u;for(i.setFont("courier"),i.setFontSize(10),o=function(n,t){return n.reduce(function(n,i){return n[i]=t[i],n},{})},r=25,t=0,e=f.length;t<e;t+=r)s=f.slice(t,t+r),u=stringTable.create(s.map(function(n){return o(["fullname","email","phone","address"],n)})),t===0&&(u="Host List ( count of hosts: "+f.length+" )\n\n"+u),i.text(20,20,u),t+r<e&&i.addPage();i.save("host-list.pdf")})}}]).controller("studentDriverMappingCtrl",["$scope","$http","$window",function(n,t,i){n.showPresentOnly=!1;n.togglePressentStudents=function(t){n.availableStudents=t?n.rawAvailableStudents.filter(function(n){return n.isPresent}):n.rawAvailableStudents};n.getAllDriverMappingPDF=function(){t.get("/api/studentDriverMapping/status").then(function(n){var i=n.data.mappedDrivers,t=new jsPDF({orientation:"l",lineHeight:1.5}),r;t.setFont("courier");t.setFontSize(11);r=function(n,t){return n.reduce(function(n,i){return n[i]=t[i],n},{})};i.map(function(n,u){var f="";n&&(f+="Driver Name: "+n.fullname+"\n",f+="Driver Contact: "+n.phone+"\n",f+="Driver Capacity: "+n.capacity+"\n",f+="\n");n.students||(n.students=[]);f+=stringTable.create(n.students.map(function(n){return r(["fullname","email","phone","country","isPresent"],n)}));t.text(20,20,f);u+1<i.length&&t.addPage()});t.save("student-driver-mapping.pdf")})};n.sendMailToDrivers=function(){i.confirm("Are you sure to email mappings to drivers?")&&t.post("/api/studentDriverMapping/EmailMappings").then(function(){i.alert("Successfully sent the mappings")})};n.getStatus=function(){return t.get("/api/studentDriverMapping/status").then(function(t){var i=t.data;n.availableDrivers=i.availableDrivers;n.availableStudents=i.availableStudents;n.rawAvailableStudents=n.availableStudents;n.mappedDrivers=i.mappedDrivers;n.availableDriversBuckets=i.availableDrivers.reduce(function(n,t){var i="host"in t&&!!t.host?t.host.fullname:"Unassigned";return(n[i]=n[i]||[]).push(t),n},{})})};n.map=function(t,i){n.changeMap(t,i,"map")};n.unmap=function(t,i){n.changeMap(t,i,"unmap")};n.changeMap=function(i,r,u){r&&i&&t.post("/api/studentDriverMapping/"+u,{driverId:r,studentId:i}).then(function(){n.getStatus()})};n.init=function(){n.getStatus()};n.init()}]).controller("studentAttendanceCtrl",["$scope","$http","$window",function(n,t,i){n.countries=["All Countries"];n.students=[];n.allStudents=[];n.country="All Countries";n.attendanceFilter="no";n.fullname="";n.drivers=[];n.availableDriversBuckets={};n.getAllDrivers=function(){t.get("/api/driver/").then(function(t){n.drivers=t.data.filter(function(n){return n.role==="Driver"});n.availableDriversBuckets=n.drivers.reduce(function(n,t){var i="host"in t&&!!t.host?t.host.fullname:"Unassigned";return(n[i]=n[i]||[]).push(t),n},{})})};n.addDriverMap=function(i,r){r&&i&&t.post("/api/studentDriverMapping/map",{driverId:r,studentId:i}).then(function(){n.getAllDrivers();n.getAllStudents()})};n.checkInViaEmail=function(){if(i.confirm("Are you sure to send check-in via email to students?"))return t.post("/api/attendance/student/sendCheckIn").then(function(){alert("Check-in via email is sent to students")})};n.getAllStudents=function(){return t.get("/api/student").then(function(t){n.students=t.data;n.allStudents=t.data;n.students.forEach(function(t){n.countries.includes(t.country)||n.countries.push(t.country)});var i=n.countries.filter(function(n){return n!=="All Countries"});i.sort();n.countries=["All Countries"].concat(i);n.updateTable()})};n.changeAttendance=function(i){return t.post("/api/attendance/student/setAttendance",{id:i.id,attendance:i.isPresent}).then(function(){n.getAllStudents()})};n.updateTable=function(){var t=n.allStudents,i={country:[],attendance:[],fullname:[]};n.country==="All Countries"?i.country=t:t.forEach(function(t){t.country===n.country&&i.country.push(t)});t=i.country;n.attendanceFilter==="all"?i.attendance=t:t.forEach(function(t){(t.isPresent&&n.attendanceFilter==="yes"||!t.isPresent&&n.attendanceFilter==="no")&&i.attendance.push(t)});t=i.attendance;n.fullname?t.forEach(function(t){t.fullname.toLowerCase().indexOf(n.fullname.toLowerCase())>-1&&i.fullname.push(t)}):i.fullname=t;t=i.fullname;n.students=t};n.init=function(){n.getAllDrivers();n.getAllStudents()};n.init()}]).controller("driverHostMappingCtrl",["$scope","$http","$window",function(n,t,i){n.getHostInfo=function(n){var t=0,i=0;return n.drivers&&(t=n.drivers.map(function(n){return n.capacity}).reduce(function(n,t){return n+t}),i=n.drivers.map(function(n){return n.students?n.students.length:0}).reduce(function(n,t){return n+t})),{hostCapacity:t,hostAssigned:i}};n.getAllDriverMappingPDF=function(){t.get("/api/driverHostMapping/status").then(function(n){var i=n.data.mappedHosts,t=new jsPDF({orientation:"l",lineHeight:1.5}),r;t.setFont("courier");t.setFontSize(11);r=function(n,t){return n.reduce(function(n,i){return n[i]=t[i],n},{})};i.map(function(n,u){var f="";n&&(f+="Host Name: "+n.fullname+"\n",f+="Host Address: "+n.address+"\n",f+="Host Contact: "+n.phone+"\n",f+="\n");f+=stringTable.create(n.drivers.map(function(n){return r(["fullname","email","phone","capacity","isPresent"],n)}));t.text(20,20,f);u+1<i.length&&t.addPage()});t.save("driver-host-mapping.pdf")})};n.sendMailToHosts=function(){i.confirm("Are you sure to email mappings to hosts?")&&t.post("/api/driverHostMapping/EmailMappings").then(function(){i.alert("Successfully sent the mappings")})};n.getStatus=function(){return t.get("/api/driverHostMapping/status").then(function(t){var i=t.data;n.availableDrivers=i.availableDrivers;n.availableHosts=i.availableHosts;n.mappedHosts=i.mappedHosts})};n.map=function(t,i){n.changeMap(t,i,"map")};n.unmap=function(t,i){n.changeMap(t,i,"unmap")};n.changeMap=function(i,r,u){i&&r&&t.post("/api/driverHostMapping/"+u,{driverId:i,hostId:r}).then(function(){n.getStatus()})};n.init=function(){n.getStatus()};n.init()}]).controller("driverAttendanceCtrl",["$scope","$http","$window",function(n,t,i){n.drivers=[];n.allDrivers=[];n.attendanceFilter="all";n.fullname="";n.checkInViaEmail=function(){if(i.confirm("Are you sure to send check-in via email to drivers?"))return t.post("/api/attendance/driver/sendCheckIn").then(function(){alert("Check-in via email is sent to drivers")})};n.getAllDrivers=function(){return t.get("/api/driver").then(function(t){n.drivers=t.data.filter(function(n){return n.role==="Driver"});n.allDrivers=t.data.filter(function(n){return n.role==="Driver"});n.updateTable()})};n.changeAttendance=function(i){return t.post("/api/attendance/driver/setAttendance",{id:i.id,attendance:i.isPresent}).then(function(){n.getAllStudents()})};n.updateTable=function(){var t=n.allDrivers,i={attendance:[],fullname:[]};n.attendanceFilter==="all"?i.attendance=t:t.forEach(function(t){(t.isPresent&&n.attendanceFilter==="yes"||!t.isPresent&&n.attendanceFilter==="no")&&i.attendance.push(t)});t=i.attendance;n.fullname?t.forEach(function(t){t.fullname.toLowerCase().indexOf(n.fullname.toLowerCase())>-1&&i.fullname.push(t)}):i.fullname=t;t=i.fullname;n.drivers=t};n.init=function(){n.getAllDrivers()};n.init()}]);